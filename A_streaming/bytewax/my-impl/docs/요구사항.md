# Crypto Candle Generator - 요구사항

## 1. 개요

### 1.1 목적
실시간 거래(Trade) 데이터를 받아 시간 윈도우 기반 OHLCV 캔들을 생성한다.

### 1.2 사용자 스토리
```
As a 데이터 엔지니어,
I want to 실시간 거래 데이터로 캔들을 생성하고 싶다,
So that 차트 분석 및 기술 지표 계산에 활용할 수 있다.
```

---

## 2. 기능 요구사항

### 2.1 Trade 입력 처리

**FR-001: Trade 데이터 수신**
```
입력 형식:
{
    "symbol": "BTCUSDT",
    "price": 50000.0,
    "quantity": 0.1,
    "timestamp": "2026-01-26T10:30:15.123Z"
}

수락 기준:
- [ ] JSON 형식 Trade 파싱 가능
- [ ] 필수 필드 누락 시 에러 처리
- [ ] timestamp는 ISO 8601 형식 지원
```

**FR-002: 심볼별 분리**
```
수락 기준:
- [ ] 여러 심볼 동시 처리 (BTCUSDT, ETHUSDT 등)
- [ ] 각 심볼별 독립적인 캔들 생성
```

---

### 2.2 윈도우 처리

**FR-003: Tumbling Window**
```
정의: 고정 크기, 겹치지 않는 윈도우

수락 기준:
- [ ] 윈도우 크기 설정 가능 (1분, 5분, 15분 등)
- [ ] 윈도우 경계는 정각 기준 (예: 10:00, 10:01, 10:02)
- [ ] 윈도우 닫힐 때 캔들 emit
```

**FR-004: Watermark 처리**
```
정의: "이 시간 이전의 모든 데이터가 도착했다"는 마커

수락 기준:
- [ ] 이벤트 시간 기준 watermark 추적
- [ ] watermark 이전 도착 데이터는 Late로 표시
- [ ] Late 데이터 처리 정책: 무시 또는 별도 출력
```

**FR-005: 윈도우 닫기 조건**
```
수락 기준:
- [ ] watermark가 윈도우 종료 시간을 넘으면 닫기
- [ ] 설정 가능한 대기 시간 (예: 5초)
```

---

### 2.3 OHLCV 캔들 생성

**FR-006: OHLCV 집계**
```
출력 형식:
{
    "symbol": "BTCUSDT",
    "interval": "1m",
    "open_time": "2026-01-26T10:30:00Z",
    "close_time": "2026-01-26T10:30:59.999Z",
    "open": 50000.0,
    "high": 50150.0,
    "low": 49950.0,
    "close": 50100.0,
    "volume": 10.5,
    "trade_count": 42
}

수락 기준:
- [ ] open: 윈도우 내 첫 번째 거래 가격
- [ ] high: 윈도우 내 최고가
- [ ] low: 윈도우 내 최저가
- [ ] close: 윈도우 내 마지막 거래 가격
- [ ] volume: 윈도우 내 총 거래량
- [ ] trade_count: 윈도우 내 거래 수
```

**FR-007: 빈 윈도우 처리**
```
수락 기준:
- [ ] 거래가 없는 윈도우는 캔들 생성 안 함 (또는 이전 close로 채우기)
```

---

### 2.4 출력

**FR-008: 캔들 출력**
```
수락 기준:
- [ ] JSON 형식으로 출력
- [ ] 콜백 함수로 출력 (확장 가능)
- [ ] (선택) Kafka Producer로 출력
```

**FR-009: Late 데이터 출력**
```
수락 기준:
- [ ] Late 데이터는 별도 콜백으로 출력
- [ ] Late 여부 + 원래 속했어야 할 윈도우 정보 포함
```

---

## 3. 비기능 요구사항

### 3.1 성능

**NFR-001: 처리량**
```
목표: 초당 1,000건 이상 Trade 처리
테스트: 벤치마크로 측정
```

### 3.2 정확성

**NFR-002: 캔들 정확성**
```
목표: 동일 입력에 대해 bytewax와 동일한 결과
테스트: 테스트 케이스로 검증
```

### 3.3 확장성

**NFR-003: 윈도우 타입 확장**
```
목표: 추후 Sliding, Session 윈도우 추가 가능한 구조
방법: 인터페이스 분리
```

---

## 4. 인터페이스

### 4.1 API

```python
# 캔들 생성기 생성
generator = CandleGenerator(
    window_size=timedelta(minutes=1),
    watermark_delay=timedelta(seconds=5),
    on_candle=lambda candle: print(candle),
    on_late=lambda trade, window_id: print(f"Late: {trade}")
)

# Trade 처리
generator.process(trade)

# 강제 flush (종료 시)
generator.flush()
```

### 4.2 데이터 모델

```python
@dataclass
class Trade:
    symbol: str
    price: float
    quantity: float
    timestamp: datetime

@dataclass
class Candle:
    symbol: str
    interval: str
    open_time: datetime
    close_time: datetime
    open: float
    high: float
    low: float
    close: float
    volume: float
    trade_count: int
```

---

## 5. 테스트 시나리오

### TC-001: 기본 캔들 생성
```
Given: 10:00:10, 10:00:30, 10:00:50에 거래 3건
When: watermark가 10:01:00을 넘음
Then: 10:00 ~ 10:01 캔들 1개 생성
```

### TC-002: 여러 윈도우
```
Given: 10:00:30, 10:01:30, 10:02:30에 거래 3건
When: watermark가 10:03:00을 넘음
Then: 각 분별 캔들 3개 생성
```

### TC-003: Late 데이터
```
Given: watermark가 10:02:00
When: 10:01:30 timestamp의 거래 도착
Then: Late로 처리, 캔들에 포함 안 됨
```

### TC-004: 여러 심볼
```
Given: BTCUSDT 2건, ETHUSDT 2건
When: 처리
Then: 각 심볼별 독립 캔들 생성
```

### TC-005: 빈 윈도우
```
Given: 10:00:30에만 거래
When: watermark가 10:03:00
Then: 10:00 캔들만 생성, 10:01, 10:02는 없음
```

---

## 6. 제약사항

```
1. 단일 프로세스 (분산 처리 X)
2. In-memory 상태 (재시작 시 상태 손실)
3. Tumbling Window만 지원 (v1)
```

---

## 7. 용어 정의

| 용어 | 정의 |
|------|------|
| **Trade** | 개별 거래 (체결) 데이터 |
| **Candle** | OHLCV 집계 데이터 |
| **Tumbling Window** | 고정 크기, 겹치지 않는 시간 윈도우 |
| **Watermark** | 이벤트 시간 진행 마커 |
| **Late Data** | Watermark 이후 도착한 과거 데이터 |
| **OHLCV** | Open, High, Low, Close, Volume |

---

*작성일: 2026-01-26*
*다음 단계: docs/설계.md 작성*
