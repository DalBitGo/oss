# Crypto Candle Generator - 설계

## 1. 아키텍처 개요

### 1.1 전체 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                        CandleGenerator                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │  Trade 입력   │→│ WindowManager │→│   Candle 출력             │  │
│  │  (JSON/Dict)  │  │  (윈도우 관리) │  │   (on_candle 콜백)       │  │
│  └──────────────┘  └──────────────┘  └──────────────────────────┘  │
│                           │                        │                │
│                           ▼                        ▼                │
│                    ┌──────────────┐        ┌──────────────┐        │
│                    │  Watermark   │        │  Late Data   │        │
│                    │  Tracker     │        │  (on_late)   │        │
│                    └──────────────┘        └──────────────┘        │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 설계 원칙

```
1. 단순함 우선: bytewax의 복잡한 분산 처리 제외
2. 핵심 패턴 유지: Clock + Windower + Logic 개념 유지
3. 확장 가능: 인터페이스로 윈도우 타입 확장 가능
4. 콜백 기반: 출력은 콜백으로 처리 (DI)
```

---

## 2. 컴포넌트 설계

### 2.1 컴포넌트 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                           candle_generator.py                        │
│                                                                      │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │                    CandleGenerator                         │    │
│   │  - window_size: timedelta                                  │    │
│   │  - watermark_delay: timedelta                             │    │
│   │  - on_candle: Callable                                    │    │
│   │  - on_late: Optional[Callable]                            │    │
│   │  - window_managers: Dict[str, WindowManager]              │    │
│   │                                                            │    │
│   │  + process(trade: Trade) → None                           │    │
│   │  + advance_watermark(timestamp: datetime) → None          │    │
│   │  + flush() → None                                         │    │
│   └───────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              │ uses                                  │
│                              ▼                                       │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │                     WindowManager                          │    │
│   │  - window_size: timedelta                                  │    │
│   │  - windows: Dict[datetime, CandleAggregator]              │    │
│   │  - watermark: datetime                                     │    │
│   │                                                            │    │
│   │  + add_trade(trade: Trade) → Optional[LateData]           │    │
│   │  + advance_watermark(ts: datetime) → List[Candle]         │    │
│   │  + flush() → List[Candle]                                 │    │
│   └───────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                              │ uses                                  │
│                              ▼                                       │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │                   CandleAggregator                         │    │
│   │  - open_time: datetime                                     │    │
│   │  - close_time: datetime                                    │    │
│   │  - open: Optional[float]                                   │    │
│   │  - high: float                                             │    │
│   │  - low: float                                              │    │
│   │  - close: Optional[float]                                  │    │
│   │  - volume: float                                           │    │
│   │  - trade_count: int                                        │    │
│   │  - first_timestamp: Optional[datetime]                     │    │
│   │  - last_timestamp: Optional[datetime]                      │    │
│   │                                                            │    │
│   │  + add_trade(trade: Trade) → None                          │    │
│   │  + to_candle(symbol: str, interval: str) → Candle         │    │
│   └───────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                              candle.py                               │
│                                                                      │
│   ┌───────────────────────┐    ┌───────────────────────┐           │
│   │        Trade          │    │        Candle         │           │
│   │  - symbol: str        │    │  - symbol: str        │           │
│   │  - price: float       │    │  - interval: str      │           │
│   │  - quantity: float    │    │  - open_time: datetime │          │
│   │  - timestamp: datetime│    │  - close_time: datetime│          │
│   │                       │    │  - open: float        │           │
│   │  + from_dict()        │    │  - high: float        │           │
│   │  + to_dict()          │    │  - low: float         │           │
│   └───────────────────────┘    │  - close: float       │           │
│                                │  - volume: float      │           │
│   ┌───────────────────────┐    │  - trade_count: int   │           │
│   │       LateData        │    │                       │           │
│   │  - trade: Trade       │    │  + to_dict()          │           │
│   │  - window_start: dt   │    └───────────────────────┘           │
│   │  - window_end: dt     │                                        │
│   └───────────────────────┘                                        │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                              window.py                               │
│                                                                      │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │                  TumblingWindow (Utility)                  │    │
│   │                                                            │    │
│   │  + get_window_start(ts: datetime, size: timedelta)        │    │
│   │  + get_window_end(start: datetime, size: timedelta)       │    │
│   └───────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 컴포넌트 책임

| 컴포넌트 | 책임 | 파일 |
|----------|------|------|
| **Trade** | 개별 거래 데이터 모델 | candle.py |
| **Candle** | OHLCV 캔들 데이터 모델 | candle.py |
| **LateData** | Late 데이터 정보 | candle.py |
| **TumblingWindow** | 윈도우 경계 계산 | window.py |
| **CandleAggregator** | OHLCV 집계 로직 | candle_generator.py |
| **WindowManager** | 윈도우별 상태 관리 | candle_generator.py |
| **CandleGenerator** | 최상위 인터페이스 | candle_generator.py |

---

## 3. 데이터 흐름

### 3.1 정상 Trade 처리

```
Trade 입력
    │
    ▼
┌──────────────────────────────────────┐
│ CandleGenerator.process(trade)       │
│                                      │
│  1. 심볼별 WindowManager 조회/생성    │
│  2. WindowManager.add_trade(trade)   │
│  3. advance_watermark(trade.ts)      │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│ WindowManager.add_trade(trade)       │
│                                      │
│  1. Late 데이터 체크                  │
│     - trade.ts < watermark? → Late   │
│  2. 윈도우 시작 시간 계산             │
│  3. CandleAggregator 조회/생성        │
│  4. aggregator.add_trade(trade)      │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│ CandleAggregator.add_trade(trade)    │
│                                      │
│  1. open = 첫 거래 가격 (타임스탬프순) │
│  2. high = max(high, price)          │
│  3. low = min(low, price)            │
│  4. close = 마지막 거래 가격          │
│  5. volume += quantity               │
│  6. trade_count += 1                 │
└──────────────────────────────────────┘
```

### 3.2 Watermark 진행 및 캔들 Emit

```
advance_watermark(new_watermark)
    │
    ▼
┌──────────────────────────────────────┐
│ 모든 WindowManager에 대해:            │
│                                      │
│  manager.advance_watermark(ts)       │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│ WindowManager.advance_watermark(ts)  │
│                                      │
│  for each window in windows:         │
│    if window.close_time < ts:        │
│      candle = aggregator.to_candle() │
│      emit candle                     │
│      remove window                   │
│                                      │
│  update watermark = ts               │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│ on_candle(candle)                    │
│                                      │
│  콜백 함수 호출                       │
│  (출력, 저장, 전송 등)                │
└──────────────────────────────────────┘
```

### 3.3 Late Data 처리

```
Trade (timestamp < watermark)
    │
    ▼
┌──────────────────────────────────────┐
│ WindowManager.add_trade(trade)       │
│                                      │
│  if trade.ts < watermark:            │
│    return LateData(                  │
│      trade=trade,                    │
│      window_start=계산된 윈도우 시작,  │
│      window_end=계산된 윈도우 종료    │
│    )                                 │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│ on_late(late_data)                   │
│                                      │
│  Late 데이터 콜백 호출                │
│  (로깅, 별도 처리 등)                 │
└──────────────────────────────────────┘
```

---

## 4. 클래스 상세 설계

### 4.1 Trade (Data Class)

```python
@dataclass
class Trade:
    """개별 거래 데이터"""
    symbol: str          # "BTCUSDT"
    price: float         # 50000.0
    quantity: float      # 0.1
    timestamp: datetime  # UTC

    @classmethod
    def from_dict(cls, data: dict) -> "Trade":
        """JSON dict → Trade 변환"""
        return cls(
            symbol=data["symbol"],
            price=float(data["price"]),
            quantity=float(data["quantity"]),
            timestamp=datetime.fromisoformat(
                data["timestamp"].replace("Z", "+00:00")
            )
        )

    def to_dict(self) -> dict:
        """Trade → JSON dict 변환"""
        return {
            "symbol": self.symbol,
            "price": self.price,
            "quantity": self.quantity,
            "timestamp": self.timestamp.isoformat()
        }
```

### 4.2 Candle (Data Class)

```python
@dataclass
class Candle:
    """OHLCV 캔들 데이터"""
    symbol: str          # "BTCUSDT"
    interval: str        # "1m", "5m"
    open_time: datetime  # 윈도우 시작
    close_time: datetime # 윈도우 종료
    open: float          # 시가
    high: float          # 고가
    low: float           # 저가
    close: float         # 종가
    volume: float        # 총 거래량
    trade_count: int     # 거래 수

    def to_dict(self) -> dict:
        """Candle → JSON dict 변환"""
        return {
            "symbol": self.symbol,
            "interval": self.interval,
            "open_time": self.open_time.isoformat(),
            "close_time": self.close_time.isoformat(),
            "open": self.open,
            "high": self.high,
            "low": self.low,
            "close": self.close,
            "volume": self.volume,
            "trade_count": self.trade_count
        }
```

### 4.3 LateData (Data Class)

```python
@dataclass
class LateData:
    """Late 데이터 정보"""
    trade: Trade           # 원본 거래
    window_start: datetime # 속했어야 할 윈도우 시작
    window_end: datetime   # 속했어야 할 윈도우 종료
```

### 4.4 TumblingWindow (Utility)

```python
class TumblingWindow:
    """Tumbling Window 경계 계산 유틸리티"""

    @staticmethod
    def get_window_start(
        timestamp: datetime,
        window_size: timedelta
    ) -> datetime:
        """
        주어진 타임스탬프가 속하는 윈도우의 시작 시간

        예: window_size=1분, ts=10:30:45 → 10:30:00
        """
        # Unix timestamp로 변환
        ts_seconds = timestamp.timestamp()
        window_seconds = window_size.total_seconds()

        # 내림 처리
        window_start_seconds = (
            int(ts_seconds // window_seconds) * window_seconds
        )

        return datetime.fromtimestamp(
            window_start_seconds,
            tz=timestamp.tzinfo
        )

    @staticmethod
    def get_window_end(
        window_start: datetime,
        window_size: timedelta
    ) -> datetime:
        """
        윈도우 종료 시간 (시작 + 크기 - 1ms)

        예: start=10:30:00, size=1분 → 10:30:59.999
        """
        return window_start + window_size - timedelta(milliseconds=1)
```

### 4.5 CandleAggregator

```python
class CandleAggregator:
    """단일 윈도우 내 OHLCV 집계"""

    def __init__(self, open_time: datetime, close_time: datetime):
        self.open_time = open_time
        self.close_time = close_time

        # OHLCV
        self.open: Optional[float] = None
        self.high: float = float('-inf')
        self.low: float = float('inf')
        self.close: Optional[float] = None
        self.volume: float = 0.0
        self.trade_count: int = 0

        # 타임스탬프 추적 (open/close 결정용)
        self.first_timestamp: Optional[datetime] = None
        self.last_timestamp: Optional[datetime] = None

    def add_trade(self, trade: Trade) -> None:
        """거래 추가 및 집계 업데이트"""
        price = trade.price
        quantity = trade.quantity
        ts = trade.timestamp

        # Open: 가장 이른 타임스탬프의 가격
        if self.first_timestamp is None or ts < self.first_timestamp:
            self.first_timestamp = ts
            self.open = price

        # High/Low
        self.high = max(self.high, price)
        self.low = min(self.low, price)

        # Close: 가장 늦은 타임스탬프의 가격
        if self.last_timestamp is None or ts > self.last_timestamp:
            self.last_timestamp = ts
            self.close = price

        # Volume & Count
        self.volume += quantity
        self.trade_count += 1

    def to_candle(self, symbol: str, interval: str) -> Candle:
        """Candle 객체 생성"""
        return Candle(
            symbol=symbol,
            interval=interval,
            open_time=self.open_time,
            close_time=self.close_time,
            open=self.open or 0.0,
            high=self.high if self.high != float('-inf') else 0.0,
            low=self.low if self.low != float('inf') else 0.0,
            close=self.close or 0.0,
            volume=self.volume,
            trade_count=self.trade_count
        )

    def is_empty(self) -> bool:
        """거래가 없는 빈 윈도우인지"""
        return self.trade_count == 0
```

### 4.6 WindowManager

```python
class WindowManager:
    """심볼별 윈도우 상태 관리"""

    def __init__(
        self,
        symbol: str,
        window_size: timedelta,
        watermark_delay: timedelta
    ):
        self.symbol = symbol
        self.window_size = window_size
        self.watermark_delay = watermark_delay

        # 윈도우 상태 (window_start → aggregator)
        self.windows: Dict[datetime, CandleAggregator] = {}

        # Watermark (이 시간 이전 데이터는 Late)
        self.watermark: Optional[datetime] = None

    def add_trade(self, trade: Trade) -> Optional[LateData]:
        """
        거래 추가

        Returns:
            LateData if trade is late, None otherwise
        """
        # Late 데이터 체크
        if self.watermark and trade.timestamp < self.watermark:
            window_start = TumblingWindow.get_window_start(
                trade.timestamp, self.window_size
            )
            window_end = TumblingWindow.get_window_end(
                window_start, self.window_size
            )
            return LateData(
                trade=trade,
                window_start=window_start,
                window_end=window_end
            )

        # 윈도우 찾기/생성
        window_start = TumblingWindow.get_window_start(
            trade.timestamp, self.window_size
        )

        if window_start not in self.windows:
            window_end = TumblingWindow.get_window_end(
                window_start, self.window_size
            )
            self.windows[window_start] = CandleAggregator(
                open_time=window_start,
                close_time=window_end
            )

        # 집계
        self.windows[window_start].add_trade(trade)
        return None

    def advance_watermark(
        self,
        timestamp: datetime
    ) -> List[Candle]:
        """
        Watermark 진행 및 닫힌 윈도우의 캔들 반환

        Args:
            timestamp: 새로운 watermark 기준 시간

        Returns:
            닫힌 윈도우들의 캔들 리스트
        """
        # watermark = 현재 시간 - delay
        new_watermark = timestamp - self.watermark_delay

        if self.watermark and new_watermark <= self.watermark:
            return []

        self.watermark = new_watermark

        # 닫힌 윈도우 찾기
        closed_candles: List[Candle] = []
        closed_windows: List[datetime] = []

        for window_start, aggregator in self.windows.items():
            # 윈도우 종료 시간이 watermark 이전이면 닫기
            if aggregator.close_time < self.watermark:
                if not aggregator.is_empty():
                    interval = self._format_interval()
                    candle = aggregator.to_candle(self.symbol, interval)
                    closed_candles.append(candle)
                closed_windows.append(window_start)

        # 닫힌 윈도우 제거
        for ws in closed_windows:
            del self.windows[ws]

        return closed_candles

    def flush(self) -> List[Candle]:
        """모든 열린 윈도우 강제 닫기"""
        candles: List[Candle] = []
        interval = self._format_interval()

        for aggregator in self.windows.values():
            if not aggregator.is_empty():
                candle = aggregator.to_candle(self.symbol, interval)
                candles.append(candle)

        self.windows.clear()
        return candles

    def _format_interval(self) -> str:
        """윈도우 크기를 interval 문자열로 변환"""
        seconds = int(self.window_size.total_seconds())
        if seconds < 60:
            return f"{seconds}s"
        elif seconds < 3600:
            return f"{seconds // 60}m"
        elif seconds < 86400:
            return f"{seconds // 3600}h"
        else:
            return f"{seconds // 86400}d"
```

### 4.7 CandleGenerator

```python
class CandleGenerator:
    """캔들 생성기 최상위 인터페이스"""

    def __init__(
        self,
        window_size: timedelta = timedelta(minutes=1),
        watermark_delay: timedelta = timedelta(seconds=5),
        on_candle: Optional[Callable[[Candle], None]] = None,
        on_late: Optional[Callable[[LateData], None]] = None
    ):
        self.window_size = window_size
        self.watermark_delay = watermark_delay
        self.on_candle = on_candle or (lambda c: None)
        self.on_late = on_late

        # 심볼별 WindowManager
        self.window_managers: Dict[str, WindowManager] = {}

    def _get_manager(self, symbol: str) -> WindowManager:
        """심볼별 WindowManager 조회/생성"""
        if symbol not in self.window_managers:
            self.window_managers[symbol] = WindowManager(
                symbol=symbol,
                window_size=self.window_size,
                watermark_delay=self.watermark_delay
            )
        return self.window_managers[symbol]

    def process(self, trade: Trade) -> None:
        """
        Trade 처리

        1. 해당 심볼의 WindowManager로 전달
        2. Late 데이터 처리
        3. Watermark 진행 및 캔들 emit
        """
        manager = self._get_manager(trade.symbol)

        # 거래 추가
        late_data = manager.add_trade(trade)

        # Late 데이터 처리
        if late_data and self.on_late:
            self.on_late(late_data)
            return

        # Watermark 진행 및 캔들 emit
        candles = manager.advance_watermark(trade.timestamp)
        for candle in candles:
            self.on_candle(candle)

    def advance_watermark(self, timestamp: datetime) -> None:
        """
        수동 watermark 진행 (외부 시간 소스 사용 시)
        """
        for manager in self.window_managers.values():
            candles = manager.advance_watermark(timestamp)
            for candle in candles:
                self.on_candle(candle)

    def flush(self) -> None:
        """
        모든 열린 윈도우 강제 닫기 (종료 시)
        """
        for manager in self.window_managers.values():
            candles = manager.flush()
            for candle in candles:
                self.on_candle(candle)
```

---

## 5. 시퀀스 다이어그램

### 5.1 기본 시나리오: 3개 Trade로 1개 Candle 생성

```
User        CandleGenerator     WindowManager     CandleAggregator
 │                │                   │                   │
 │ process(t1)    │                   │                   │
 │──────────────>│                   │                   │
 │               │ add_trade(t1)     │                   │
 │               │─────────────────>│                   │
 │               │                   │ add_trade(t1)     │
 │               │                   │─────────────────>│
 │               │                   │                   │
 │               │ advance_wm()      │                   │
 │               │─────────────────>│                   │
 │               │     []            │ (윈도우 아직 열림)   │
 │               │<─────────────────│                   │
 │               │                   │                   │
 │ process(t2)    │                   │                   │
 │──────────────>│                   │                   │
 │               │ ...similar...     │                   │
 │               │                   │                   │
 │ process(t3)    │                   │                   │
 │──────────────>│ (t3 timestamp > window_end + delay)  │
 │               │ add_trade(t3)     │                   │
 │               │─────────────────>│ (새 윈도우)        │
 │               │ advance_wm()      │                   │
 │               │─────────────────>│                   │
 │               │                   │ to_candle()       │
 │               │                   │─────────────────>│
 │               │                   │     Candle       │
 │               │                   │<─────────────────│
 │               │  [Candle]         │                   │
 │               │<─────────────────│                   │
 │               │                   │                   │
 │ on_candle(c)  │                   │                   │
 │<──────────────│                   │                   │
 │               │                   │                   │
```

---

## 6. 파일 구조

```
my-impl/
├── README.md                   # PRD
├── docs/
│   ├── 요구사항.md              # 상세 요구사항
│   ├── 설계.md                 # 이 파일
│   └── COMPARISON.md           # 원본 vs 내 구현 비교
├── src/
│   ├── __init__.py
│   ├── candle.py               # Trade, Candle, LateData 모델
│   ├── window.py               # TumblingWindow 유틸리티
│   └── candle_generator.py     # CandleAggregator, WindowManager, CandleGenerator
└── tests/
    ├── __init__.py
    ├── test_candle.py          # 모델 테스트
    ├── test_window.py          # 윈도우 계산 테스트
    └── test_generator.py       # 통합 테스트
```

---

## 7. 구현 순서

```
1. candle.py (모델)
   - Trade, Candle, LateData dataclass
   - from_dict, to_dict 메서드

2. window.py (윈도우 유틸리티)
   - TumblingWindow.get_window_start()
   - TumblingWindow.get_window_end()

3. candle_generator.py (핵심 로직)
   - CandleAggregator
   - WindowManager
   - CandleGenerator

4. tests/ (테스트)
   - 단위 테스트 (모델, 윈도우)
   - 통합 테스트 (요구사항 테스트 시나리오)
```

---

## 8. 원본 bytewax와의 매핑

| bytewax | 내 구현 | 설명 |
|---------|---------|------|
| EventClock | trade.timestamp 사용 | 이벤트 시간 기준 처리 |
| TumblingWindower | TumblingWindow | 윈도우 경계 계산 |
| FoldWindowLogic | CandleAggregator | 집계 로직 |
| StatefulBatchLogic | WindowManager | 상태 관리 |
| Dataflow | CandleGenerator | 최상위 API |

---

*작성일: 2026-01-26*
*다음 단계: src/ 코드 구현*
