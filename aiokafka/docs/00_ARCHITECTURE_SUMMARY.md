# aiokafka ì „ì²´ ì•„í‚¤í…ì²˜ ìš”ì•½

## ğŸ“š í”„ë¡œì íŠ¸ ê°œìš”
- **í”„ë¡œì íŠ¸**: aiokafka
- **ì €ì¥ì†Œ**: https://github.com/aio-libs/aiokafka
- **ëª©ì **: **ìˆœìˆ˜ Python asyncio ê¸°ë°˜ Kafka í´ë¼ì´ì–¸íŠ¸**
- **íŠ¹ì§•**: librdkafka ì—†ì´ Kafka Wire Protocolì„ ì§ì ‘ êµ¬í˜„

---

## ğŸ›ï¸ ì „ì²´ ê³„ì¸µ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Application                                         â”‚
â”‚  (Producer/Consumer API ì‚¬ìš©)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer (Producer & Consumer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Producer                   â”‚  Consumer            â”‚  â”‚
â”‚  â”‚  - AIOKafkaProducer         â”‚  - AIOKafkaConsumer  â”‚  â”‚
â”‚  â”‚  - MessageAccumulator       â”‚  - Fetcher           â”‚  â”‚
â”‚  â”‚  - Sender                   â”‚  - GroupCoordinator  â”‚  â”‚
â”‚  â”‚  - TransactionManager       â”‚  - SubscriptionState â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Layer (Cluster Management)                        â”‚
â”‚  - AIOKafkaClient (ì—°ê²° í’€, ë©”íƒ€ë°ì´í„° ë™ê¸°í™”)            â”‚
â”‚  - ClusterMetadata (ë¸Œë¡œì»¤, í† í”½, íŒŒí‹°ì…˜ ì •ë³´ ì €ì¥)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Protocol Layer (Kafka Wire Protocol)                     â”‚
â”‚  - types.py (Int32, String, Array, Schema ë“±)            â”‚
â”‚  - struct.py (Request/Response ë² ì´ìŠ¤)                   â”‚
â”‚  - metadata.py, produce.py, fetch.py ë“± (46ê°œ API)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Network Layer (TCP/TLS + SASL)                          â”‚
â”‚  - AIOKafkaConnection (asyncio StreamReader/Writer)      â”‚
â”‚  - SASL ì¸ì¦ (PLAIN, GSSAPI, SCRAM, OAUTHBEARER)        â”‚
â”‚  - Correlation ID ë§¤ì¹­, íƒ€ì„ì•„ì›ƒ ê´€ë¦¬                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ ì£¼ìš” ëª¨ë“ˆ ìƒì„¸

### ğŸ”¹ **Network Layer** (conn.py)
**ì—­í• **: Kafka ë¸Œë¡œì»¤ì™€ì˜ TCP ì—°ê²° ê´€ë¦¬

**í•µì‹¬ í´ë˜ìŠ¤**:
- `AIOKafkaConnection`: ë‹¨ì¼ ë¸Œë¡œì»¤ ì—°ê²°
  - asyncio StreamReader/Writer ì‚¬ìš©
  - Correlation IDë¡œ ìš”ì²­/ì‘ë‹µ ë§¤ì¹­
  - SASL ì¸ì¦ (PLAIN, GSSAPI, SCRAM-SHA-256/512, OAUTHBEARER)
  - API ë²„ì „ í˜‘ìƒ
  - ìœ íœ´ ì—°ê²° íƒ€ì„ì•„ì›ƒ

**íŠ¹ì§•**:
- âœ… Big-Endian ë°”ì´íŠ¸ ìˆœì„œ
- âœ… Weakrefë¡œ ë©”ëª¨ë¦¬ ë¦­ ë°©ì§€
- âœ… CloseReasonìœ¼ë¡œ ì¢…ë£Œ ì›ì¸ ì¶”ì 
- âœ… Future ê¸°ë°˜ ë¹„ë™ê¸° ì‘ë‹µ ì²˜ë¦¬

---

### ğŸ”¹ **Client Layer** (client.py, cluster.py)

#### **AIOKafkaClient** (client.py)
**ì—­í• **: í´ëŸ¬ìŠ¤í„° ì—°ê²° í’€ ë° ë©”íƒ€ë°ì´í„° ê´€ë¦¬

**í•µì‹¬ ê¸°ëŠ¥**:
- ì—°ê²° í’€ ê´€ë¦¬: `_conns = {(node_id, group): AIOKafkaConnection}`
- ë°±ê·¸ë¼ìš´ë“œ ë©”íƒ€ë°ì´í„° ë™ê¸°í™” (`_md_synchronizer` íƒœìŠ¤í¬)
- API ë²„ì „ ìë™ ê°ì§€ (`check_version()`)
- Coordinator ì¡°íšŒ (Group/Transaction)

**ë©”íƒ€ë°ì´í„° ê°±ì‹ **:
```
ì£¼ê¸°ì  (metadata_max_age_ms: 5ë¶„)
    or
ê°•ì œ (í† í”½ ì¶”ê°€, ì—°ê²° ì‹¤íŒ¨ ì‹œ)
    â†“
MetadataRequest ì „ì†¡
    â†“
cluster.update_metadata(response)
```

#### **ClusterMetadata** (cluster.py)
**ì—­í• **: ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œ (IO ì—†ìŒ)

**ì €ì¥ ë°ì´í„°**:
```python
_brokers = {node_id: BrokerMetadata}
_partitions = {topic: {partition: PartitionMetadata}}
_broker_partitions = {node_id: {TopicPartition}}
_coordinators = {node_id: BrokerMetadata}
```

**íŠ¹ì§•**:
- âœ… ìˆœìˆ˜ ë°ì´í„° êµ¬ì¡° (ë„¤íŠ¸ì›Œí¬ ì—†ìŒ)
- âœ… threading.Lockìœ¼ë¡œ ìŠ¤ë ˆë“œ ì•ˆì „
- âœ… Observer íŒ¨í„´ (ë¦¬ìŠ¤ë„ˆ ì½œë°±)

---

### ğŸ”¹ **Protocol Layer** (protocol/)

#### **íƒ€ì… ì‹œìŠ¤í…œ** (types.py)
**ì—­í• **: Kafka Wire Protocol ê¸°ë³¸ íƒ€ì… êµ¬í˜„

**ì§€ì› íƒ€ì…**:
```
ê¸°ë³¸: Int8, Int16, Int32, UInt32, Int64, Boolean, Float64
ê°€ë³€: String, Bytes, Array, Schema
VarInt: UnsignedVarInt32, VarInt32, VarInt64
Compact: CompactString, CompactBytes, CompactArray, TaggedFields
```

**ì¸ì½”ë”© ì˜ˆì‹œ**:
```python
String("test") â†’ b'\x00\x04test'
Array([1, 2, 3]) â†’ b'\x00\x00\x00\x03\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x03'
```

#### **Request/Response** (struct.py, api.py)
**ì—­í• **: ëª¨ë“  í”„ë¡œí† ì½œì˜ ë² ì´ìŠ¤ í´ë˜ìŠ¤

**êµ¬ì¡°**:
```python
class MetadataRequest_v1(Request):
    API_KEY = 3
    API_VERSION = 1
    RESPONSE_TYPE = MetadataResponse_v1
    SCHEMA = Schema(
        ('topics', Array(String('utf-8')))
    )
```

**ë©”ì‹œì§€ í˜•ì‹**:
```
[4-byte size][RequestHeader][RequestBody]

RequestHeader:
  - api_key (Int16)
  - api_version (Int16)
  - correlation_id (Int32)
  - client_id (String)
```

#### **46ê°œ API í”„ë¡œí† ì½œ**
- **Core**: Metadata, Produce, Fetch, ListOffsets
- **Consumer**: FindCoordinator, JoinGroup, SyncGroup, Heartbeat, OffsetCommit, OffsetFetch
- **Transaction**: InitProducerId, AddPartitionsToTxn, EndTxn
- **Admin**: CreateTopics, DeleteTopics, DescribeConfigs, AlterConfigs ë“±

---

### ğŸ”¹ **Producer Layer** (producer/)

#### **AIOKafkaProducer** (producer.py)
**ì—­í• **: ë©”ì‹œì§€ ì „ì†¡ API

**í•µì‹¬ íë¦„**:
```
await producer.send("test", value="hello", key="user1")
    â†“
1. _serialize(key, value) â†’ bytes
2. _partition(key_bytes) â†’ partition (hash ê¸°ë°˜)
3. _message_accumulator.add_message() â†’ ë°°ì¹˜ ë²„í¼
    â†“
Sender (ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬)
    â†“
ProduceRequest ì „ì†¡ â†’ ProduceResponse
    â†“
Future.set_result(RecordMetadata)
```

**í•µì‹¬ ì»´í¬ë„ŒíŠ¸**:
- **MessageAccumulator**: íŒŒí‹°ì…˜ë³„ ë°°ì¹˜ ë²„í¼, ì••ì¶•
- **Sender**: ë°±ê·¸ë¼ìš´ë“œ ì „ì†¡ íƒœìŠ¤í¬, ì¬ì‹œë„
- **TransactionManager**: íŠ¸ëœì­ì…˜ ë° Idempotence

**ì£¼ìš” ì„¤ì •**:
| ì„¤ì • | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| `acks` | ì‘ë‹µ ëŒ€ê¸° ìˆ˜ì¤€ (0, 1, 'all') | 1 |
| `compression_type` | ì••ì¶• (gzip, snappy, lz4, zstd) | None |
| `max_batch_size` | ë°°ì¹˜ ìµœëŒ€ í¬ê¸° | 16KB |
| `linger_ms` | ë°°ì¹˜ ëŒ€ê¸° ì‹œê°„ | 0 (ì¦‰ì‹œ) |
| `enable_idempotence` | ì¤‘ë³µ ë°©ì§€ | False |

---

### ğŸ”¹ **Consumer Layer** (consumer/)

#### **AIOKafkaConsumer** (consumer.py)
**ì—­í• **: ë©”ì‹œì§€ ìˆ˜ì‹  API

**í•µì‹¬ íë¦„**:
```
await consumer.subscribe(['test'])
    â†“
GroupCoordinator
    â†“
1. FindCoordinator (Coordinator ì°¾ê¸°)
2. JoinGroup (ê·¸ë£¹ ê°€ì…, Leader ì„ ì¶œ)
3. SyncGroup (íŒŒí‹°ì…˜ í• ë‹¹)
4. Heartbeat (ë°±ê·¸ë¼ìš´ë“œ)
    â†“
msg = await consumer.getone()
    â†“
Fetcher
    â†“
1. FetchRequest ì „ì†¡ (Prefetch)
2. FetchResponse íŒŒì‹± (RecordBatch)
3. ì—­ì§ë ¬í™”
    â†“
return ConsumerRecord
```

**í•µì‹¬ ì»´í¬ë„ŒíŠ¸**:
- **GroupCoordinator**: Consumer Group í”„ë¡œí† ì½œ ê´€ë¦¬
- **Fetcher**: FetchRequest, Prefetch ë²„í¼, ì—­ì§ë ¬í™”
- **SubscriptionState**: íŒŒí‹°ì…˜ë³„ ì˜¤í”„ì…‹ ì¶”ì 

**ì£¼ìš” ì„¤ì •**:
| ì„¤ì • | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| `group_id` | Consumer Group ID | None |
| `auto_offset_reset` | ì˜¤í”„ì…‹ ì—†ì„ ë•Œ ('earliest', 'latest') | 'latest' |
| `enable_auto_commit` | ìë™ ì»¤ë°‹ ì—¬ë¶€ | True |
| `max_poll_records` | í•œ ë²ˆ fetch ìµœëŒ€ ë ˆì½”ë“œ | 500 |

---

## ğŸ”„ ì£¼ìš” ì‹¤í–‰ íë¦„

### **Producer ë©”ì‹œì§€ ì „ì†¡**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Code      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ await producer.send("test", value="hello")
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIOKafkaProducer                   â”‚
â”‚  1. Serialize (key, value â†’ bytes) â”‚
â”‚  2. Partition (hash(key) % 3)      â”‚
â”‚  3. Add to MessageAccumulator      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (ë²„í¼ì— ì¶”ê°€, Future ë°˜í™˜)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sender (ë°±ê·¸ë¼ìš´ë“œ)                 â”‚
â”‚  1. ë°°ì¹˜ ìˆ˜ì§‘ (linger_ms ëŒ€ê¸°)      â”‚
â”‚  2. ì••ì¶• (gzip)                     â”‚
â”‚  3. ProduceRequest ìƒì„±             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIOKafkaClient                     â”‚
â”‚  - node_id ì„ íƒ (partition leader)  â”‚
â”‚  - conn.send(ProduceRequest)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIOKafkaConnection                 â”‚
â”‚  - header + body ì¸ì½”ë”©             â”‚
â”‚  - TCP ì „ì†¡                         â”‚
â”‚  - ì‘ë‹µ ëŒ€ê¸° (correlation_id)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProduceResponse                    â”‚
â”‚  - partition, offset, error_code    â”‚
â”‚  - Future.set_result(metadata)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Code      â”‚
â”‚  metadata = await fut  â”‚
â”‚  â†’ RecordMetadata(offset=123) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Consumer ë©”ì‹œì§€ ìˆ˜ì‹ **
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Code      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ await consumer.subscribe(['test'])
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GroupCoordinator                   â”‚
â”‚  1. FindCoordinator                â”‚
â”‚  2. JoinGroup (Leader ì„ ì¶œ)        â”‚
â”‚  3. SyncGroup (íŒŒí‹°ì…˜ í• ë‹¹)        â”‚
â”‚  4. Heartbeat ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (íŒŒí‹°ì…˜ í• ë‹¹ ì™„ë£Œ)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Code      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ msg = await consumer.getone()
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fetcher                            â”‚
â”‚  1. Prefetch ë²„í¼ í™•ì¸              â”‚
â”‚  2. ë²„í¼ ì—†ìœ¼ë©´ FetchRequest ì „ì†¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIOKafkaClient                     â”‚
â”‚  - conn.send(FetchRequest)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FetchResponse                      â”‚
â”‚  - RecordBatch íŒŒì‹±                 â”‚
â”‚  - ì••ì¶• í•´ì œ                        â”‚
â”‚  - ì—­ì§ë ¬í™”                         â”‚
â”‚  - Prefetch ë²„í¼ì— ì €ì¥             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Code      â”‚
â”‚  msg = ConsumerRecord(...)  â”‚
â”‚  â†’ msg.value = "hello"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ í•µì‹¬ íŠ¹ì§•

### **1. ìˆœìˆ˜ Python êµ¬í˜„**
- âœ… librdkafka ì—†ìŒ â†’ C ì˜ì¡´ì„± ì œê±°
- âœ… Kafka Wire Protocol ì™„ì „ êµ¬í˜„
- âœ… íƒ€ì… ì‹œìŠ¤í…œ (Int32, String, Array ë“±)
- âœ… 46ê°œ API í”„ë¡œí† ì½œ ì§€ì›

### **2. asyncio ë„¤ì´í‹°ë¸Œ**
- âœ… async/await ë¬¸ë²•
- âœ… asyncio StreamReader/Writer
- âœ… Future ê¸°ë°˜ ì‘ë‹µ ì²˜ë¦¬
- âœ… ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ (Sender, Heartbeat, Metadata)

### **3. í”„ë¡œë•ì…˜ ê¸°ëŠ¥**
- âœ… **ì••ì¶•**: gzip, snappy, lz4, zstd
- âœ… **ë°°ì¹˜ ì²˜ë¦¬**: MessageAccumulator
- âœ… **ì¬ì‹œë„**: Sender ìë™ ì¬ì‹œë„
- âœ… **Idempotence**: ì¤‘ë³µ ë°©ì§€ (Sequence)
- âœ… **íŠ¸ëœì­ì…˜**: Exactly-Once Semantics
- âœ… **Consumer Group**: íŒŒí‹°ì…˜ ìë™ í• ë‹¹, ë¦¬ë°¸ëŸ°ì‹±
- âœ… **ì˜¤í”„ì…‹ ê´€ë¦¬**: ìë™/ìˆ˜ë™ ì»¤ë°‹
- âœ… **SASL ì¸ì¦**: PLAIN, GSSAPI, SCRAM, OAUTHBEARER
- âœ… **SSL/TLS**: ì•”í˜¸í™” í†µì‹ 

### **4. ì„±ëŠ¥ ìµœì í™”**
- âœ… **Prefetch**: Consumerê°€ ë¯¸ë¦¬ ë©”ì‹œì§€ ê°€ì ¸ì˜´
- âœ… **ë°°ì¹˜ ì „ì†¡**: ì—¬ëŸ¬ ë©”ì‹œì§€ë¥¼ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ
- âœ… **ì••ì¶•**: ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì ˆì•½
- âœ… **ì—°ê²° í’€**: ë¸Œë¡œì»¤ë³„ ì—°ê²° ì¬ì‚¬ìš©
- âœ… **Back-pressure**: ë²„í¼ ì œí•œìœ¼ë¡œ ë©”ëª¨ë¦¬ ë³´í˜¸

---

## ğŸ“– í•™ìŠµ í¬ì¸íŠ¸

### **Kafka í”„ë¡œí† ì½œ ì´í•´**
1. **Wire Protocol**: Big-Endian, VarInt, Compact íƒ€ì…
2. **API ë²„ì „ ê´€ë¦¬**: MetadataRequest v0 ~ v5
3. **Correlation ID**: ìš”ì²­/ì‘ë‹µ ë§¤ì¹­
4. **Consumer Group**: JoinGroup, SyncGroup, Heartbeat
5. **íŠ¸ëœì­ì…˜**: InitProducerId, AddPartitionsToTxn

### **asyncio íŒ¨í„´**
1. **ë¹„ë™ê¸° I/O**: StreamReader/Writer
2. **Future**: ë¹„ë™ê¸° ì‘ë‹µ ëŒ€ê¸°
3. **ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬**: create_task()
4. **Weakref**: ìˆœí™˜ ì°¸ì¡° ë°©ì§€
5. **Context Manager**: async with

### **ì•„í‚¤í…ì²˜ ì„¤ê³„**
1. **ê³„ì¸µ ë¶„ë¦¬**: Network â†’ Protocol â†’ Client â†’ Application
2. **Observer íŒ¨í„´**: ë©”íƒ€ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
3. **Template Method**: Struct ë² ì´ìŠ¤ í´ë˜ìŠ¤
4. **Strategy**: Partitioner, Serializer
5. **ë°°ì¹˜ ì²˜ë¦¬**: MessageAccumulator

---

## ğŸ“Š ë¶„ì„ ë¬¸ì„œ ëª©ë¡

### **Core ê³„ì¸µ**
1. `conn.py.md` - TCP ì—°ê²° & SASL ì¸ì¦
2. `client.py.md` - ì—°ê²° í’€ & ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
3. `cluster.py.md` - ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œ

### **Protocol ê³„ì¸µ**
4. `protocol_overview.md` - ì „ì²´ ê°œìš” (46ê°œ API)
5. `protocol_types.py.md` - íƒ€ì… ì‹œìŠ¤í…œ
6. `protocol_struct_api.md` - Request/Response ë² ì´ìŠ¤
7. `protocol_metadata.py.md` - Metadata API ì˜ˆì‹œ

### **Producer ê³„ì¸µ**
8. `producer_overview.md` - Producer API & ë©”ì‹œì§€ ì „ì†¡

### **Consumer ê³„ì¸µ**
9. `consumer_overview.md` - Consumer API & ë©”ì‹œì§€ ìˆ˜ì‹ 

### **ì „ì²´ ìš”ì•½**
10. **`00_ARCHITECTURE_SUMMARY.md`** (ì´ ë¬¸ì„œ)

---

## ğŸ“ ê²°ë¡ 

**aiokafka**ëŠ”:
1. âœ… **ìˆœìˆ˜ Python**ìœ¼ë¡œ Kafkaë¥¼ ì™„ì „íˆ êµ¬í˜„í•œ í”„ë¡œì íŠ¸
2. âœ… **asyncio ë„¤ì´í‹°ë¸Œ**ë¡œ ê³ ì„±ëŠ¥ ë¹„ë™ê¸° I/O ì œê³µ
3. âœ… **í”„ë¡œë•ì…˜ ê¸°ëŠ¥** ì™„ë¹„ (íŠ¸ëœì­ì…˜, Idempotence, Consumer Group)
4. âœ… **êµìœ¡ì  ê°€ì¹˜**: Kafka í”„ë¡œí† ì½œ ë° asyncio íŒ¨í„´ í•™ìŠµ

â†’ **Python asyncio + Kafka**ë¥¼ ë°°ìš°ë ¤ë©´ **í•„ìˆ˜ë¡œ ë¶„ì„í•´ì•¼ í•  í”„ë¡œì íŠ¸**!
